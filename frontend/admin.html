<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - The Hungry Spot</title>
    <link rel="icon" type="image/x-icon" href="logo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-section {
            display: none;
        }

        .login-container {
            max-width: 400px;
            margin: 100px auto;
        }

        .order-card {
            margin-bottom: 20px;
            transition: transform 0.2s;
        }

        .order-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .order-items {
            font-size: 0.9rem;
            color: #666;
        }

        /* Table Maps Styles */
        .table-map {
            position: relative;
            width: 100%;
            height: 500px;
            background-color: #f8f9fa;
            border: 2px solid #dee2e6;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .table-item {
            position: absolute;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #333;
            font-size: 0.8rem;
            z-index: 10;
        }

        .table-item:hover {
            transform: scale(1.1);
            z-index: 20;
        }

        .table-rect {
            width: 50px;
            height: 50px;
            background-color: #fff;
            border: 2px solid #6c757d;
            border-radius: 4px;
        }

        .table-diamond {
            width: 50px;
            height: 50px;
            background-color: #fff;
            border: 2px solid #6c757d;
            transform: rotate(45deg);
            border-radius: 4px;
        }

        .table-diamond span {
            transform: rotate(-45deg);
        }

        .table-round {
            width: 50px;
            height: 50px;
            background-color: #fff;
            border: 2px solid #6c757d;
            border-radius: 50%;
        }

        .table-occupied {
            background-color: #dc3545 !important;
            border-color: #dc3545 !important;
            color: white !important;
            cursor: pointer;
            /* Admin can click to free it */
        }

        .table-available {
            background-color: #d1e7dd;
            border-color: #198754;
        }

        /* Chairs visual using pseudo-elements */
        .table-rect::before,
        .table-rect::after,
        .table-diamond::before,
        .table-diamond::after,
        .table-round::before,
        .table-round::after {
            content: '';
            position: absolute;
            width: 15px;
            height: 15px;
            background-color: #adb5bd;
            border-radius: 50%;
            z-index: -1;
        }
    </style>
</head>

<body class="bg-light">

    <!-- Login Section -->
    <div id="loginSection" class="container login-container">
        <div class="card shadow-lg border-0 rounded-4">
            <div class="card-body p-5">
                <div class="text-center mb-4">
                    <img src="logo.png" width="80" alt="Logo">
                    <h3 class="mt-3 fw-bold">Admin Login</h3>
                </div>
                <form id="loginForm">
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input type="text" id="username" class="form-control" required placeholder="Enter username">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <input type="password" id="password" class="form-control" required placeholder="Enter password">
                    </div>
                    <button type="submit" class="btn btn-warning w-100 py-2 fw-bold text-white">Login</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboardSection" class="admin-section container py-5">
        <div class="d-flex justify-content-between align-items-center mb-5">
            <div>
                <h1 class="fw-bold m-0"><span class="text-warning">Admin</span> Dashboard</h1>
                <p class="text-muted">Manage your restaurant orders and menu</p>
            </div>
            <div class="d-flex gap-2">
                <button id="downloadCsv" class="btn btn-success d-flex align-items-center gap-2">
                    <i class="bi bi-download"></i> Download CSV
                </button>
                <button id="clearOrders" class="btn btn-outline-danger d-flex align-items-center gap-2">
                    <i class="bi bi-eraser"></i> Clear All
                </button>
                <button id="logoutBtn" class="btn btn-outline-danger">Logout</button>
            </div>
        </div>

        <ul class="nav nav-tabs mb-4 border-0 gap-3" id="adminTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="btn btn-outline-warning active px-4 rounded-pill" id="orders-tab" data-bs-toggle="tab"
                    data-bs-target="#orders" type="button" role="tab">Orders</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="btn btn-outline-warning px-4 rounded-pill" id="menu-tab" data-bs-toggle="tab"
                    data-bs-target="#menu-mgmt" type="button" role="tab" onclick="loadMenu()">Menu Management</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="btn btn-outline-warning px-4 rounded-pill" id="tables-tab" data-bs-toggle="tab"
                    data-bs-target="#table-mgmt" type="button" role="tab" onclick="loadTables()">Table
                    Management</button>
            </li>
        </ul>

        <div class="tab-content" id="adminTabsContent">
            <!-- Orders Tab -->
            <div class="tab-pane fade show active" id="orders" role="tabpanel">
                <div class="row" id="ordersList">
                    <!-- Orders will be loaded here -->
                </div>
            </div>

            <!-- Menu Management Tab -->
            <div class="tab-pane fade" id="menu-mgmt" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="fw-bold m-0 text-dark">Current Menu <span class="badge bg-warning ms-2"
                            id="menuCount">0</span></h3>
                    <button class="btn btn-warning text-white fw-bold px-4 rounded-pill" data-bs-toggle="modal"
                        data-bs-target="#addItemModal">
                        <i class="bi bi-plus-lg me-2"></i> Add Item
                    </button>
                </div>
                <div class="row" id="menuList">
                    <!-- Menu items will be loaded here -->
                </div>
            </div>

            <!-- Table Management Tab -->
            <div class="tab-pane fade" id="table-mgmt" role="tabpanel">
                <div class="mb-4">
                    <h3 class="fw-bold m-0 text-dark">Manage Tables</h3>
                    <p class="text-muted">Click a table to toggle availability.</p>
                </div>
                <div class="card border-0 shadow-sm rounded-4 p-3">
                    <div class="d-flex justify-content-center mb-3">
                        <span
                            class="badge bg-success-subtle text-success border border-success-subtle mx-2">Available</span>
                        <span
                            class="badge bg-danger-subtle text-danger border border-danger-subtle mx-2">Occupied</span>
                    </div>
                    <div class="table-map rounded-3 bg-white" id="adminTableMap">
                        <!-- Tables injected by JS -->
                        <div class="position-absolute bottom-0 start-0 p-2 bg-light border-top border-end rounded-top-end small fw-bold"
                            style="z-index: 5;">Entrance</div>
                        <div class="position-absolute top-0 end-0 p-2 bg-light border-bottom border-start rounded-bottom-start small fw-bold"
                            style="z-index: 5;">Restrooms</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Item Modal -->
    <div class="modal fade" id="addItemModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold">Add New Food Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="addItemForm">
                    <div class="modal-body p-4">
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Item Name</label>
                            <input type="text" id="itemName" class="form-control bg-light border-0 py-2"
                                placeholder="e.g. Cheese Burger" required>
                        </div>
                        <div class="row mb-3">
                            <div class="col">
                                <label class="form-label small fw-bold">Price (₹)</label>
                                <input type="number" id="itemPrice" class="form-control bg-light border-0 py-2"
                                    placeholder="60" required>
                            </div>
                            <div class="col">
                                <label class="form-label small fw-bold">Category</label>
                                <input type="text" id="itemCategory" class="form-control bg-light border-0 py-2"
                                    placeholder="burger spicy" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Image URL</label>
                            <input type="text" id="itemImage" class="form-control bg-light border-0 py-2"
                                placeholder="assets/pic1.jpg" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Description (Optional)</label>
                            <input type="text" id="itemDesc" class="form-control bg-light border-0 py-2"
                                placeholder="Delecious and Spicy">
                        </div>
                        <div class="form-check form-switch mt-3">
                            <input class="form-check-input" type="checkbox" id="itemSpecial">
                            <label class="form-check-label small fw-bold" for="itemSpecial">Mark as Today's
                                Special</label>
                        </div>
                    </div>
                    <div class="modal-footer border-0 pt-0">
                        <button type="button" class="btn btn-light rounded-pill px-4"
                            data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-warning text-white fw-bold rounded-pill px-4">Add
                            Item</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function () {
            const API_URL = window.location.origin.includes('localhost') ? 'http://localhost:5000/api' : window.location.origin + '/api';
            let token = localStorage.getItem('adminToken');

            if (token) {
                showDashboard();
            }

            $('#loginForm').submit(function (e) {
                e.preventDefault();
                const username = $('#username').val();
                const password = $('#password').val();
                const $btn = $(this).find('button[type="submit"]');

                $btn.prop('disabled', true).text('Logging in...');

                $.ajax({
                    url: `${API_URL}/admin/login`,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ username, password }),
                    success: function (response) {
                        localStorage.setItem('adminToken', response.token);
                        showDashboard();
                        $btn.prop('disabled', false).text('Login');
                    },
                    error: function (xhr, status, error) {
                        console.error("Login failed:", error);
                        $btn.prop('disabled', false).text('Login');

                        if (xhr.status === 0) {
                            alert('Cannot connect to server! Is the backend running on port 5000?');
                        } else if (xhr.status === 401) {
                            alert('Invalid Username or Password');
                        } else {
                            alert('Login error: ' + (xhr.responseJSON ? xhr.responseJSON.message : 'Unknown error'));
                        }
                    }
                });
            });

            $('#logoutBtn').click(function () {
                localStorage.removeItem('adminToken');
                location.reload();
            });

            function showDashboard() {
                $('#loginSection').hide();
                $('#dashboardSection').show();
                loadOrders();
                loadMenu();
            }

            function loadOrders() {
                $.ajax({
                    url: `${API_URL}/admin/orders`,
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('adminToken')}` },
                    success: function (orders) {
                        $('#ordersList').empty();
                        if (orders.length === 0) {
                            $('#ordersList').append('<div class="col-12 text-center py-5"><h3>No orders yet</h3></div>');
                            return;
                        }
                        orders.reverse().forEach(order => {
                            const items = order.cart.map(item => item.title).join(', ');
                            const orderHtml = `
                                <div class="col-md-6 col-lg-4 mb-4" id="order-card-${order.id}">
                                    <div class="card order-card border-0 shadow-sm rounded-4 h-100 position-relative">
                                        <button class="btn btn-danger btn-sm rounded-circle position-absolute top-0 end-0 m-3 delete-order shadow-sm" data-id="${order.id}" style="z-index: 10;">
                                            <i class="bi bi-x"></i>
                                        </button>
                                        <div class="card-body p-4">
                                            <div class="d-flex justify-content-between mb-3">
                                                <span class="badge bg-warning-subtle text-warning border border-warning-subtle px-3 py-2 rounded-pill">Order #${order.id.toString().slice(-6)}</span>
                                                <small class="text-muted">${new Date(order.date).toLocaleDateString()}</small>
                                            </div>
                                            <h5 class="fw-bold mb-1 text-dark">${order.firstName} ${order.lastName}</h5>
                                            <p class="text-muted mb-3 small"><i class="bi bi-envelope me-2"></i>${order.email}</p>
                                            <div class="p-3 bg-light rounded-3 mb-3">
                                                <p class="order-items mb-0"><strong>Items:</strong> ${items}</p>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="fw-bold fs-5 text-warning">₹${order.totalCost}</span>
                                                <span class="text-muted small">${order.address}, ${order.state || ''}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                            $('#ordersList').append(orderHtml);
                        });
                    }
                });
            }

            window.loadMenu = function () {
                $.ajax({
                    url: `${API_URL}/menu?t=${new Date().getTime()}`,
                    method: 'GET',
                    success: function (menu) {
                        $('#menuList').empty();
                        $('#menuCount').text(menu.length);
                        menu.forEach(item => {
                            const checked = item.available ? 'checked' : '';
                            const statusLabel = item.available ? 'Available' : 'Not Available';
                            const itemHtml = `
                                <div class="col-md-6 col-lg-4 mb-4" id="item-card-${item.id}">
                                    <div class="card border-0 shadow-sm rounded-4 h-100 overflow-hidden">
                                        <div class="card-body d-flex gap-3 align-items-center p-3">
                                            <img src="${item.image}" width="70" height="70" class="rounded-3 object-fit-cover shadow-sm bg-light" onerror="this.src='https://via.placeholder.com/70?text=Food'">
                                            <div class="flex-grow-1">
                                                <h6 class="fw-bold mb-1 text-dark">${item.title}</h6>
                                                <p class="small text-muted mb-0">₹${item.price} <span class="ms-1 badge bg-light text-secondary small" style="font-size: 0.6rem;">${item.categories}</span></p>
                                                <span class="badge ${item.available ? 'bg-success-subtle text-success' : 'bg-danger-subtle text-danger'} rounded-pill mt-1" id="status-${item.id}">${statusLabel}</span>
                                                ${item.special ? '<span class="badge bg-warning-subtle text-warning rounded-pill mt-1 ms-1">Special</span>' : ''}
                                            </div>
                                            <div class="d-flex flex-column gap-2 align-items-center">
                                                <div class="form-check form-switch p-0 m-0">
                                                    <input class="form-check-input menu-toggle m-0" type="checkbox" data-id="${item.id}" ${checked} style="cursor: pointer; transform: scale(1.2);">
                                                </div>
                                                <button class="btn btn-outline-danger btn-sm border-0 delete-item" data-id="${item.id}" title="Remove Item">
                                                    <i class="bi bi-trash3"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                            $('#menuList').append(itemHtml);
                        });
                    }
                });
            }

            window.loadTables = function () {
                $.ajax({
                    url: `${API_URL}/tables?t=${new Date().getTime()}`,
                    method: 'GET',
                    success: function (tables) {
                        const $map = $('#adminTableMap');
                        $map.empty();

                        $map.append('<div class="position-absolute bottom-0 start-0 p-2 bg-light border-top border-end rounded-top-end small fw-bold" style="z-index: 5;">Entrance</div>');
                        $map.append('<div class="position-absolute top-0 end-0 p-2 bg-light border-bottom border-start rounded-bottom-start small fw-bold" style="z-index: 5;">Restrooms</div>');

                        tables.forEach(table => {
                            const isOccupied = table.status === 'occupied';
                            const className = `table-item table-${table.type} ${isOccupied ? 'table-occupied' : 'table-available'}`;
                            const $el = $(`<div class="${className}" style="left:${table.x}%; top:${table.y}%;"><span>${table.label}</span></div>`);

                            $el.click(function () {
                                const newStatus = isOccupied ? 'available' : 'occupied';
                                if (confirm(`Change Table ${table.label} status to ${newStatus}?`)) {
                                    updateTableStatus(table.id, newStatus);
                                }
                            });

                            $map.append($el);
                        });
                    }
                });
            }

            function updateTableStatus(id, status) {
                $.ajax({
                    url: `${API_URL}/admin/tables/${id}`,
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('adminToken')}` },
                    contentType: 'application/json',
                    data: JSON.stringify({ status }),
                    success: function () {
                        loadTables();
                    },
                    error: function (xhr) {
                        alert('Error updating table: ' + (xhr.responseJSON ? xhr.responseJSON.message : 'Unknown error'));
                    }
                });
            }

            $('#addItemForm').submit(function (e) {
                e.preventDefault();
                const newItem = {
                    title: $('#itemName').val(),
                    price: parseFloat($('#itemPrice').val()),
                    categories: $('#itemCategory').val(),
                    image: $('#itemImage').val(),
                    description: $('#itemDesc').val(),
                    special: $('#itemSpecial').is(':checked')
                };

                $.ajax({
                    url: `${API_URL}/admin/menu`,
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('adminToken')}` },
                    contentType: 'application/json',
                    data: JSON.stringify(newItem),
                    success: function () {
                        bootstrap.Modal.getInstance(document.getElementById('addItemModal')).hide();
                        $('#addItemForm')[0].reset();
                        loadMenu();
                    }
                });
            });

            $(document).on('click', '.delete-order', function () {
                const id = $(this).data('id');
                if (!confirm('Are you sure you want to delete this order?')) return;

                $.ajax({
                    url: `${API_URL}/admin/orders/${id}`,
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('adminToken')}` },
                    success: function () {
                        $(`#order-card-${id}`).fadeOut(300, function () { $(this).remove(); });
                    }
                });
            });

            $('#clearOrders').click(function () {
                console.log('Clear Orders clicked');
                if (!confirm('WARNING: This will delete ALL orders. Have you downloaded the CSV first?')) return;

                $.ajax({
                    url: `${API_URL}/admin/orders`,
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('adminToken')}` },
                    success: function () {
                        console.log('Clear Orders Success');
                        $('#ordersList').html('<div class="col-12 text-center py-5"><h3>All orders cleared</h3></div>');
                        alert('All orders have been cleared.');
                    },
                    error: function (xhr) {
                        console.error('Clear Orders Failed', xhr);
                        alert('Error: ' + (xhr.responseJSON ? xhr.responseJSON.message : 'Could not clear orders. Session may have expired.'));
                    }
                });
            });

            $(document).on('click', '.delete-item', function () {
                if (!confirm('Are you sure you want to delete this item?')) return;

                const id = $(this).data('id');
                $.ajax({
                    url: `${API_URL}/admin/menu/${id}`,
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('adminToken')}` },
                    success: function () {
                        $(`#item-card-${id}`).fadeOut(300, function () { $(this).remove(); });
                        let count = parseInt($('#menuCount').text());
                        $('#menuCount').text(count - 1);
                    },
                    error: function (xhr) {
                        alert('Error deleting item: ' + (xhr.responseJSON ? xhr.responseJSON.message : 'Unknown error'));
                    }
                });
            });

            $(document).on('change', '.menu-toggle', function () {
                const id = $(this).data('id');
                const available = $(this).is(':checked');
                const $statusBadge = $(`#status-${id}`);

                $.ajax({
                    url: `${API_URL}/admin/menu/${id}`,
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('adminToken')}` },
                    contentType: 'application/json',
                    data: JSON.stringify({ available }),
                    success: function () {
                        if (available) {
                            $statusBadge.removeClass('bg-danger-subtle text-danger').addClass('bg-success-subtle text-success').text('Available');
                        } else {
                            $statusBadge.removeClass('bg-success-subtle text-success').addClass('bg-danger-subtle text-danger').text('Not Available');
                        }
                    },
                    error: function () {
                        alert('Failed to update availability.');
                    }
                });
            });

            $('#downloadCsv').click(function () {
                const currentToken = localStorage.getItem('adminToken');
                if (!currentToken) {
                    alert('You are not logged in!');
                    return;
                }

                $.ajax({
                    url: `${API_URL}/admin/export`,
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${currentToken}` },
                    xhrFields: { responseType: 'blob' },
                    success: function (data, status, xhr) {
                        const blob = new Blob([data], { type: 'text/csv' });
                        const link = document.createElement('a');
                        link.href = window.URL.createObjectURL(blob);
                        link.download = `orders_${new Date().toLocaleDateString().replace(/\//g, '-')}.csv`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        alert('CSV Downloaded successfully!');
                    },
                    error: function (xhr) {
                        alert('Failed to download CSV. Session may have expired.');
                    }
                });
            });
        });
    </script>
</body>

</html>